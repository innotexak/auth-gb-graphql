@page
@model Auth.API.Pages.Dm.ChatModel
@using System.Security.Claims
@using System.Text.Json
@{
    ViewData["Title"] = "Chat";
}

<div class="flex h-[100vh] bg-slate-50">
    <div id="usersSidebar" class="w-80 bg-white border-r border-slate-200 flex flex-col transition-all duration-300 max-md:absolute max-md:left-0 max-md:top-0 max-md:h-full max-md:z-40">
        <div class="p-4 border-b border-slate-200">
            <h1 class="text-2xl font-semibold text-slate-900">Chat</h1>
        </div>

        <div id="usersList" class="flex-1 overflow-y-auto">
            @* If users were fetched on server, we can render them immediately or pass to JS *@
            <p id="usersLoading" class="text-sm text-slate-500 text-center py-8">Loading users...</p>
        </div>
    </div>

    <div class="flex-1 flex flex-col">
        <div id="chatHeader" class="bg-white border-b border-slate-200 p-4 hidden flex items-center justify-between">
            <div class="flex items-center gap-3">
                <button id="backBtn" type="button" class="md:hidden p-2 hover:bg-slate-100 rounded-md transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </button>
                <p class="text-lg font-semibold text-slate-900" id="selectedUserName"></p>
            </div>
        </div>

        <div id="noUserSelected" class="flex-1 flex items-center justify-center text-slate-400">
            <p>Select a user to start messaging</p>
        </div>

        <div id="chat" class="flex-1 overflow-y-auto space-y-3 p-4 hidden bg-white">
           
       
        </div>

        <div id="chat" class="flex-1 overflow-y-auto space-y-3 p-4 hidden bg-white">
        </div>

        <div id="typingIndicator" class="px-4 py-2 text-xs text-slate-500 italic hidden">
            <span id="typingText">Someone is typing...</span>
        </div>
   
        <form id="dmForm" class="bg-white border-t border-slate-200 p-4 hidden">
            <div class="flex gap-3">
                <input id="messageInput" class="flex-1 rounded border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="Write a message..." />
                <button id="sendBtn" type="button" class="px-4 py-2 rounded bg-sky-600 text-white text-sm font-medium hover:bg-sky-700">Send</button>
            </div>
        </form>
    </div>
</div>

@* PASS SERVER DATA TO JAVASCRIPT SAFELY *@
<div id="app-data"
     data-current-user-id="@Model.User.FindFirstValue(ClaimTypes.NameIdentifier)" 
     data-initial-users='@Html.Raw(JsonSerializer.Serialize(Model.Users, new JsonSerializerOptions { PropertyNamingPolicy = JsonNamingPolicy.CamelCase }))'> 
</div>

<script src="~/js/dm-chat.js" type="text/javascript">

</script>